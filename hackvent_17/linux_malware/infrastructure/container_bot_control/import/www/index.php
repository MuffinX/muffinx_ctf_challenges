<?php

session_start();

$xor_key = array(0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x88, 0x99, 0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x88, 0x99, 0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF);

$mysqli = new mysqli('127.0.0.1', 'root', '', 'muffin_bot');

if ($mysqli->connect_errno) {
    die("[-] Connection Error: " . $mysqli->connect_error);
}

# signed nonce
if(isset($_POST['nonce'])) {
  $nonce = $_POST['nonce'];
  $ip = $_SERVER['REMOTE_ADDR'];

  $nonce_sql = "UPDATE twitter_names SET nonce_last_signed=NOW() WHERE ip=? AND nonce=?;";
  $nonce_statement = $mysqli->prepare($nonce_sql);
  $nonce_statement->bind_param('ss', $ip, $nonce);
  $nonce_statement->execute();

  die("");
}

# printing unsigned nonce
if(isset($_GET['nonce'])) {

  $nonce = "";
  for($i = 0; $i < sizeof($xor_key); $i++) {
    $nonce .= chr(rand(0, 256));
  }

  $nonce_enc = base64_encode($nonce);

  $ip = $_SERVER['REMOTE_ADDR'];

  $nonce_sql = "UPDATE twitter_names SET nonce=? WHERE ip=?;";
  $nonce_statement = $mysqli->prepare($nonce_sql);
  $nonce_statement->bind_param('ss', $nonce_enc, $ip);
  $nonce_statement->execute();


  $xored_nonce = "";
  for($i = 0; $i < sizeof($xor_key); $i++) {
    $xored_nonce .= chr(ord($nonce{$i}) ^ $xor_key{$i});
  }

  die(base64_encode($xored_nonce));
}



if(isset($_GET['twitter'])) {
  $twitter_names = $mysqli->query('SELECT name FROM twitter_names WHERE nonce_last_signed > DATE_SUB(NOW(),INTERVAL 30 SECOND);');
  $twitter_names->data_seek(0);
  while($twitter_name = $twitter_names->fetch_assoc()){
      echo $twitter_name['name'] . '|';
  }
  exit(0);
}


echo '<html>
<head></head>
<body>';

if(isset($_POST['password'])) {
  $password = $_POST['password'];

  $aes_enc = '';
  $aes_enc_sql = "SELECT AES_ENCRYPT('".$password."','muffin_botz_hax_pw') AS enc FROM passwords";
  $aes_query = $mysqli->query($aes_enc_sql);

  if(!$aes_query) {
    die('[-] query failed : '.$aes_enc_sql);
  }

  while($aes_row = $aes_query->fetch_object()) {
    $aes_enc =  $aes_row->enc;
  }

  if(empty($aes_enc)) {
    die('[-] query failed : empty');
  }

  $pw_sql = "SELECT password FROM passwords WHERE password=?";
  $pw_statement = $mysqli->prepare($pw_sql);
  $pw_statement->bind_param('s', $aes_enc);
  $pw_statement->execute();

  $pw_result = $pw_statement->get_result();

  while($pw_row = $pw_result->fetch_object()) {
    $_SESSION['logged_in']= true;
  }

}

if(isset($_SESSION['logged_in'])) {

  if(isset($_POST['twitter_name'])) {
    $twitter_name = $_POST['twitter_name'];
    $ip = $_SERVER['REMOTE_ADDR'];

    if(empty($twitter_name)) { exit(0); }
    if(strlen($twitter_name) > 15) { exit(0); }
    $twitter_name = str_replace('|','',$twitter_name);


    $twitter_sql = "INSERT INTO twitter_names (ip,name) VALUES (?,?) ON DUPLICATE KEY UPDATE name = ?;";
    $twitter_statement = $mysqli->prepare($twitter_sql);
    $twitter_statement->bind_param('sss', $ip, $twitter_name, $twitter_name);
    $twitter_statement->execute();

  }

  echo '
  <center>
    <iframe height="100%" width="100%" src="https://www.youtube.com/embed/s2jvANh2aEc?rel=0&amp;controls=0&amp;showinfo=0&amp;autoplay=1" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
  </center>

  <form action="" method="POST">
    <input type="text" name="twitter_name" hidden />
    <input type="submit" name="Submit" value="Add Twitter Name" hidden />
  </form>
';

}
else {
    echo '

<center>
  <iframe height="100%" width="100%" src="https://www.youtube.com/embed/dQw4w9WgXcQ?rel=0&amp;controls=0&amp;showinfo=0&amp;autoplay=1" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
</center>

<form action="" method="POST">
  <input type="text" name="password" hidden />
  <input type="submit" name="Submit" value="Login" hidden />
</form>
';
}

echo '
</body>
</html>';

?>
